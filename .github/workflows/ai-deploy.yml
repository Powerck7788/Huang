name: AI å°ˆç”¨è‡ªå‹•åŒ–éƒ¨ç½² / AI Automated Deployment

# é€™å€‹å·¥ä½œæµç¨‹å°ˆé–€ç‚º AI ä»£ç†è¨­è¨ˆï¼Œå¯ä»¥é€éŽå¤šç¨®æ–¹å¼è§¸ç™¼
on:
  # å…è¨±å¾ž GitHub Actions é é¢æ‰‹å‹•è§¸ç™¼ï¼ˆé©åˆ AI ä»£ç†ä½¿ç”¨ï¼‰
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'éƒ¨ç½²é¡žåž‹ / Deployment Type'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview    # é è¦½éƒ¨ç½²
          - staging    # æ¸¬è©¦ç’°å¢ƒéƒ¨ç½²
          - production # ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²
      environment:
        description: 'ç›®æ¨™ç’°å¢ƒ / Target Environment'
        required: false
        default: 'default'
      version:
        description: 'ç‰ˆæœ¬æ¨™ç±¤ / Version Tag'
        required: false
        default: 'latest'
      ai_agent:
        description: 'AI ä»£ç†è­˜åˆ¥ / AI Agent ID'
        required: false
        default: 'github-copilot'

  # ç•¶æœ‰æ–°çš„ release æ¨™ç±¤æˆ–ç‰¹å®šåˆ†æ”¯æŽ¨é€æ™‚è‡ªå‹•è§¸ç™¼
  push:
    tags:
      - 'v*'
      - 'release-*'
    branches:
      - 'deploy/**'
      - 'ai-deploy/**'

  # å…è¨±å…¶ä»–å·¥ä½œæµç¨‹èª¿ç”¨
  workflow_call:
    inputs:
      deployment_type:
        required: true
        type: string
      environment:
        required: false
        type: string
        default: 'default'

# ç’°å¢ƒè®Šæ•¸
env:
  NODE_VERSION: '18'
  DEPLOY_DIR: 'dist'

# è¨­ç½®å·¥ä½œæµç¨‹ç´šåˆ¥çš„æ¬Šé™ï¼ˆæœ€å°æ¬Šé™åŽŸå‰‡ï¼‰
permissions:
  contents: read
  actions: read

jobs:
  # æº–å‚™éšŽæ®µï¼šæª¢æŸ¥ç’°å¢ƒå’Œåƒæ•¸
  prepare:
    name: æº–å‚™éƒ¨ç½²ç’°å¢ƒ / Prepare Deployment
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      deployment_type: ${{ steps.set-params.outputs.deployment_type }}
      environment: ${{ steps.set-params.outputs.environment }}
      version: ${{ steps.set-params.outputs.version }}
      timestamp: ${{ steps.set-params.outputs.timestamp }}
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼ / Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è¨­ç½®éƒ¨ç½²åƒæ•¸ / Set deployment parameters
        id: set-params
        run: |
          echo "ðŸ¤– AI ä»£ç†éƒ¨ç½²å•Ÿå‹•..."
          echo "AI Agent Deployment initiated..."
          
          # è¨­ç½®éƒ¨ç½²é¡žåž‹
          DEPLOY_TYPE="${{ github.event.inputs.deployment_type || 'preview' }}"
          echo "deployment_type=${DEPLOY_TYPE}" >> $GITHUB_OUTPUT
          
          # è¨­ç½®ç’°å¢ƒ
          ENV="${{ github.event.inputs.environment || 'default' }}"
          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          
          # è¨­ç½®ç‰ˆæœ¬
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ -n "${{ github.ref_name }}" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="$(git rev-parse --short HEAD)"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          # è¨­ç½®æ™‚é–“æˆ³
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ éƒ¨ç½²åƒæ•¸ / Deployment Parameters:"
          echo "  é¡žåž‹/Type: ${DEPLOY_TYPE}"
          echo "  ç’°å¢ƒ/Environment: ${ENV}"
          echo "  ç‰ˆæœ¬/Version: ${VERSION}"
          echo "  æ™‚é–“/Timestamp: ${TIMESTAMP}"
          
          # å¦‚æžœæ˜¯ AI ä»£ç†è§¸ç™¼ï¼Œè¨˜éŒ„ä¸‹ä¾†
          if [ -n "${{ github.event.inputs.ai_agent }}" ]; then
            echo "ðŸ¤– AI ä»£ç†: ${{ github.event.inputs.ai_agent }}"
          fi

      - name: é©—è­‰æ¬Šé™ / Validate permissions
        run: |
          echo "âœ… æ¬Šé™é©—è­‰é€šéŽ"
          echo "Permission validation passed"

  # æ§‹å»ºéšŽæ®µ
  build:
    name: æ§‹å»ºæ‡‰ç”¨ç¨‹å¼ / Build Application
    runs-on: ubuntu-latest
    needs: prepare
    permissions:
      contents: read
      actions: write  # éœ€è¦ä¸Šå‚³ artifacts
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼ / Checkout code
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js / Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: æª¢æŸ¥æ§‹å»ºéœ€æ±‚ / Check build requirements
        id: check-build
        run: |
          if [ -f "package.json" ]; then
            echo "has_package_json=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰¾åˆ° package.json"
          else
            echo "has_package_json=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  æœªæ‰¾åˆ° package.jsonï¼Œè·³éŽ npm æ§‹å»º"
          fi

      - name: å®‰è£ä¾è³´ / Install dependencies
        if: steps.check-build.outputs.has_package_json == 'true'
        run: |
          echo "ðŸ“¦ å®‰è£ä¾è³´..."
          npm ci || npm install

      - name: åŸ·è¡Œæ§‹å»º / Run build
        if: steps.check-build.outputs.has_package_json == 'true'
        run: |
          echo "ðŸ”¨ é–‹å§‹æ§‹å»º..."
          if grep -q "\"build\":" package.json; then
            npm run build
          else
            echo "âš ï¸  æœªæ‰¾åˆ° build è…³æœ¬ï¼Œè·³éŽæ§‹å»ºæ­¥é©Ÿ"
          fi

      - name: æº–å‚™éƒ¨ç½²æ–‡ä»¶ / Prepare deployment files
        run: |
          echo "ðŸ“ æº–å‚™éƒ¨ç½²æ–‡ä»¶..."
          mkdir -p deployment-package
          
          # è¤‡è£½é‡è¦æ–‡ä»¶
          cp -r . deployment-package/ || true
          
          # æŽ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
          cd deployment-package
          rm -rf .git node_modules .github || true
          
          echo "âœ… éƒ¨ç½²åŒ…æº–å‚™å®Œæˆ"
          ls -la

      - name: ä¸Šå‚³æ§‹å»ºç”¢ç‰© / Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: deployment-package-${{ needs.prepare.outputs.version }}
          path: deployment-package/
          retention-days: 7

  # æ¸¬è©¦éšŽæ®µï¼ˆå¯é¸ï¼‰
  test:
    name: åŸ·è¡Œæ¸¬è©¦ / Run Tests
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: needs.prepare.outputs.deployment_type != 'production'
    permissions:
      contents: read
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼ / Checkout code
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js / Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: åŸ·è¡Œæ¸¬è©¦ / Run tests
        run: |
          echo "ðŸ§ª åŸ·è¡Œæ¸¬è©¦..."
          if [ -f "package.json" ]; then
            npm ci || npm install
            if grep -q "\"test\":" package.json; then
              npm test || echo "âš ï¸  æ¸¬è©¦å¤±æ•—ï¼Œä½†ç¹¼çºŒéƒ¨ç½²"
            else
              echo "âš ï¸  æœªæ‰¾åˆ°æ¸¬è©¦è…³æœ¬"
            fi
          else
            echo "âœ… æ²’æœ‰æ¸¬è©¦éœ€è¦åŸ·è¡Œ"
          fi

  # éƒ¨ç½²éšŽæ®µ
  deploy:
    name: éƒ¨ç½²åˆ° ${{ needs.prepare.outputs.environment }} / Deploy to ${{ needs.prepare.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [prepare, build]
    permissions:
      contents: read
      actions: read  # éœ€è¦ä¸‹è¼‰ artifacts
    environment:
      name: ${{ needs.prepare.outputs.deployment_type }}
      url: https://github.com/${{ github.repository }}
    
    steps:
      - name: ä¸‹è¼‰æ§‹å»ºç”¢ç‰© / Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: deployment-package-${{ needs.prepare.outputs.version }}
          path: ./deploy

      - name: é¡¯ç¤ºéƒ¨ç½²ä¿¡æ¯ / Display deployment info
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸš€ é–‹å§‹éƒ¨ç½² / Starting Deployment"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“‹ éƒ¨ç½²ä¿¡æ¯ / Deployment Information:"
          echo "  é¡žåž‹ / Type: ${{ needs.prepare.outputs.deployment_type }}"
          echo "  ç’°å¢ƒ / Environment: ${{ needs.prepare.outputs.environment }}"
          echo "  ç‰ˆæœ¬ / Version: ${{ needs.prepare.outputs.version }}"
          echo "  æ™‚é–“ / Timestamp: ${{ needs.prepare.outputs.timestamp }}"
          echo "  è§¸ç™¼è€… / Triggered by: ${{ github.actor }}"
          if [ -n "${{ github.event.inputs.ai_agent }}" ]; then
            echo "  ðŸ¤– AI ä»£ç† / AI Agent: ${{ github.event.inputs.ai_agent }}"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo "ðŸ“ éƒ¨ç½²æ–‡ä»¶åˆ—è¡¨ / Deployment files:"
          ls -la ./deploy

      - name: åŸ·è¡Œéƒ¨ç½²è…³æœ¬ / Execute deployment script
        run: |
          echo "ðŸš€ åŸ·è¡Œéƒ¨ç½²..."
          
          cd ./deploy
          
          # æ ¹æ“šéƒ¨ç½²é¡žåž‹åŸ·è¡Œä¸åŒçš„éƒ¨ç½²é‚è¼¯
          case "${{ needs.prepare.outputs.deployment_type }}" in
            "preview")
              echo "ðŸ“± éƒ¨ç½²åˆ°é è¦½ç’°å¢ƒ..."
              echo "Deploying to preview environment..."
              # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„é è¦½éƒ¨ç½²é‚è¼¯
              ;;
            "staging")
              echo "ðŸ§ª éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ..."
              echo "Deploying to staging environment..."
              # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„æ¸¬è©¦ç’°å¢ƒéƒ¨ç½²é‚è¼¯
              ;;
            "production")
              echo "ðŸ­ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ..."
              echo "Deploying to production environment..."
              # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²é‚è¼¯
              ;;
          esac
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "Deployment completed!"

      - name: å‰µå»ºéƒ¨ç½²æ¨™ç±¤ / Create deployment tag
        run: |
          echo "ðŸ·ï¸  å‰µå»ºéƒ¨ç½²æ¨™ç±¤..."
          DEPLOY_TAG="deploy-${{ needs.prepare.outputs.deployment_type }}-${{ needs.prepare.outputs.timestamp }}"
          echo "æ¨™ç±¤ / Tag: ${DEPLOY_TAG}"
          
          # åœ¨å¯¦éš›ç’°å¢ƒä¸­ï¼Œé€™è£¡å¯ä»¥å‰µå»º Git æ¨™ç±¤æˆ–å…¶ä»–æ¨™è¨˜

  # é€šçŸ¥éšŽæ®µ
  notify:
    name: ç™¼é€éƒ¨ç½²é€šçŸ¥ / Send Deployment Notification
    runs-on: ubuntu-latest
    needs: [prepare, deploy]
    if: always()
    permissions:
      contents: read  # æœ€å°æ¬Šé™
    
    steps:
      - name: ç”Ÿæˆéƒ¨ç½²å ±å‘Š / Generate deployment report
        run: |
          echo "ðŸ“Š ç”Ÿæˆéƒ¨ç½²å ±å‘Š..."
          echo "Generating deployment report..."
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“‹ éƒ¨ç½²å ±å‘Š / Deployment Report"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ç‹€æ…‹ / Status: ${{ needs.deploy.result }}"
          echo "é¡žåž‹ / Type: ${{ needs.prepare.outputs.deployment_type }}"
          echo "ç’°å¢ƒ / Environment: ${{ needs.prepare.outputs.environment }}"
          echo "ç‰ˆæœ¬ / Version: ${{ needs.prepare.outputs.version }}"
          echo "æ™‚é–“ / Time: ${{ needs.prepare.outputs.timestamp }}"
          echo "è§¸ç™¼è€… / Triggered by: ${{ github.actor }}"
          
          if [ -n "${{ github.event.inputs.ai_agent }}" ]; then
            echo "ðŸ¤– AI ä»£ç† / AI Agent: ${{ github.event.inputs.ai_agent }}"
          fi
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼ / Deployment Successful!"
          else
            echo "âŒ éƒ¨ç½²å¤±æ•— / Deployment Failed"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: éƒ¨ç½²æ‘˜è¦ / Deployment Summary
        run: |
          echo "### ðŸš€ AI è‡ªå‹•åŒ–éƒ¨ç½²å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‹€æ…‹ | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²é¡žåž‹ | ${{ needs.prepare.outputs.deployment_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç’°å¢ƒ | ${{ needs.prepare.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | ${{ needs.prepare.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ™‚é–“æˆ³ | ${{ needs.prepare.outputs.timestamp }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ github.event.inputs.ai_agent }}" ]; then
            echo "| AI ä»£ç† | ${{ github.event.inputs.ai_agent }} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… **éƒ¨ç½²æˆåŠŸå®Œæˆï¼**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **éƒ¨ç½²å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ**" >> $GITHUB_STEP_SUMMARY
          fi
